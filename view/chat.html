<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; }
    .chat-container { max-width: 1100px; margin: 20px auto; }
    .sidebar {
      background-color: #2c3e50;
      color: white;
      padding: 15px;
      border-radius: 8px 0 0 8px;
      min-height: 600px;
    }
    .sidebar h5 { color: #ecf0f1; }
    .sidebar .member { padding: 3px 0; font-size: 0.9em; }
    .chat-area {
      background-color: #fff;
      border-radius: 0 8px 8px 0;
      display: flex;
      flex-direction: column;
      min-height: 600px;
    }
    .chat-header {
      background-color: #34495e;
      color: white;
      padding: 10px 15px;
      border-radius: 0 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      max-height: 450px;
    }
    .message {
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #e8f4f8;
      border-radius: 8px;
      max-width: 80%;
    }
    .message.bot {
      background: #f0f0f0;
      font-style: italic;
    }
    .message.private {
      background: #fff3cd;
      border-left: 3px solid #ffc107;
    }
    .message .meta {
      font-size: 0.75em;
      color: #888;
      margin-bottom: 2px;
    }
    .message .meta strong { color: #2c3e50; }
    .chat-input {
      padding: 10px 15px;
      border-top: 1px solid #ddd;
    }
    .typing-indicator {
      padding: 0 15px;
      font-size: 0.85em;
      color: #888;
      font-style: italic;
      height: 20px;
    }
    #room-selection {
      max-width: 500px;
      margin: 100px auto;
    }
    .private-chat-badge {
      background: #ffc107;
      color: #000;
      font-size: 0.75em;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 5px;
    }
    .member-item {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .member-item:hover { background: rgba(255,255,255,0.1); }
    .member-item.active-dm { background: rgba(255,193,7,0.3); }
  </style>
</head>
<body>

  <!-- Room Selection View -->
  <div id="room-selection">
    <div class="card shadow">
      <div class="card-body p-4">
        <h2 class="text-center mb-4">Chat App</h2>
        <div class="mb-3">
          <label class="form-label"><strong>Username</strong></label>
          <input type="text" class="form-control" id="display-username" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label"><strong>Room</strong></label>
          <select class="form-select" id="room-select"></select>
        </div>
        <button class="btn btn-dark w-100" id="join-btn">Join Chat Room</button>
        <button class="btn btn-outline-danger w-100 mt-2" id="logout-btn-selection">Logout</button>
      </div>
    </div>
  </div>

  <!-- Chat View -->
  <div id="chat-view" class="chat-container d-none">
    <div class="row g-0">
      <!-- Sidebar -->
      <div class="col-md-3 sidebar">
        <h4 class="mb-3">Chat App</h4>
        <p><strong>Room name:</strong> <span id="room-name"></span></p>
        <p><strong>Members:</strong></p>
        <div id="members-list"></div>
        <hr style="border-color: #555;">
        <p class="mt-2" style="font-size:0.85em; color:#aaa;">Click a member to send a private message</p>
      </div>

      <!-- Chat Area -->
      <div class="col-md-9 chat-area">
        <div class="chat-header">
          <div>
            <span id="chat-title">Room Chat</span>
            <span id="dm-badge" class="private-chat-badge d-none">Private</span>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-light me-2" id="back-to-room-btn" style="display:none;">Back to Room</button>
            <button class="btn btn-sm btn-warning" id="leave-btn">Leave Room</button>
          </div>
        </div>
        <div class="messages" id="messages"></div>
        <div class="typing-indicator" id="typing-indicator"></div>
        <div class="chat-input">
          <form id="message-form" class="d-flex">
            <input type="text" class="form-control me-2" id="msg-input" placeholder="Type your message here..." autocomplete="off">
            <button type="submit" class="btn btn-success">Send</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Check auth
    const username = localStorage.getItem('chat_username');
    if (!username) {
      window.location.href = '/login.html';
    }

    const socket = io();
    let currentRoom = null;
    let privateChatUser = null; // When set, messages go as private
    let typingTimeout = null;

    // Set username display
    $('#display-username').val(username);

    // Load rooms
    fetch('/api/rooms')
      .then(res => res.json())
      .then(rooms => {
        rooms.forEach(room => {
          $('#room-select').append(`<option value="${room}">${room}</option>`);
        });
      });

    // Join room
    $('#join-btn').on('click', function() {
      const room = $('#room-select').val();
      if (!room) return;

      currentRoom = room;
      socket.emit('joinRoom', { username, room });

      $('#room-selection').addClass('d-none');
      $('#chat-view').removeClass('d-none');
      $('#room-name').text(room);
      $('#chat-title').text(`Room: ${room}`);
      privateChatUser = null;
    });

    // Leave room
    $('#leave-btn').on('click', function() {
      socket.emit('leaveRoom');
      currentRoom = null;
      privateChatUser = null;
      $('#chat-view').addClass('d-none');
      $('#room-selection').removeClass('d-none');
      $('#messages').html('');
      $('#members-list').html('');
    });

    // Logout
    function logout() {
      socket.emit('leaveRoom');
      localStorage.removeItem('chat_username');
      localStorage.removeItem('chat_firstname');
      localStorage.removeItem('chat_lastname');
      window.location.href = '/login.html';
    }

    $('#logout-btn-selection').on('click', logout);

    // Receive messages
    socket.on('message', function(data) {
      if (!privateChatUser) {
        appendMessage(data);
      } else if (data.from_user === 'Chat App Bot') {
        // Still show bot messages even in DM view
      }
    });

    // Previous messages on room join
    socket.on('previousMessages', function(messages) {
      messages.forEach(msg => appendMessage(msg));
    });

    // Private messages
    socket.on('privateMessage', function(data) {
      if (privateChatUser &&
          (data.from_user === privateChatUser || data.to_user === privateChatUser)) {
        appendMessage(data, true);
      } else if (!privateChatUser && data.from_user !== username) {
        // Notification in room chat
        appendMessage({
          from_user: 'Chat App Bot',
          message: `Private message from ${data.from_user} (click their name to view)`,
          date_sent: new Date()
        });
      }
    });

    // Room users
    socket.on('roomUsers', function(users) {
      $('#members-list').html('');
      users.forEach(u => {
        const isMe = u.username === username;
        const activeClass = (privateChatUser === u.username) ? 'active-dm' : '';
        $('#members-list').append(
          `<div class="member-item ${activeClass}" data-username="${u.username}">
            ${u.username} ${isMe ? '(You)' : ''}
          </div>`
        );
      });

      // Click member for private chat
      $('.member-item').on('click', function() {
        const clickedUser = $(this).data('username');
        if (clickedUser === username) return; // Can't DM yourself

        privateChatUser = clickedUser;
        $('#messages').html('');
        $('#chat-title').text(`Private chat with ${clickedUser}`);
        $('#dm-badge').removeClass('d-none');
        $('#back-to-room-btn').show();

        // Highlight active DM user
        $('.member-item').removeClass('active-dm');
        $(this).addClass('active-dm');

        // Load private message history
        fetch(`/api/private-messages/${username}/${clickedUser}`)
          .then(res => res.json())
          .then(messages => {
            messages.forEach(msg => appendMessage(msg, true));
          });
      });
    });

    // Back to room chat
    $('#back-to-room-btn').on('click', function() {
      privateChatUser = null;
      $('#messages').html('');
      $('#chat-title').text(`Room: ${currentRoom}`);
      $('#dm-badge').addClass('d-none');
      $(this).hide();
      $('.member-item').removeClass('active-dm');

      // Reload room messages
      fetch(`/api/messages/${currentRoom}`)
        .then(res => res.json())
        .then(messages => {
          messages.forEach(msg => appendMessage(msg));
        });
    });

    // Send message
    $('#message-form').on('submit', function(e) {
      e.preventDefault();
      const msg = $('#msg-input').val().trim();
      if (!msg) return;

      if (privateChatUser) {
        socket.emit('privateMessage', { to_user: privateChatUser, message: msg });
      } else {
        socket.emit('chatMessage', msg);
      }

      $('#msg-input').val('');
      socket.emit('stopTyping', { room: currentRoom, to_user: privateChatUser });
    });

    // Typing indicator
    $('#msg-input').on('input', function() {
      socket.emit('typing', { username, room: currentRoom, to_user: privateChatUser });

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('stopTyping', { room: currentRoom, to_user: privateChatUser });
      }, 1500);
    });

    socket.on('typing', function(data) {
      $('#typing-indicator').text(`${data.username} is typing...`);
    });

    socket.on('stopTyping', function() {
      $('#typing-indicator').text('');
    });

    // Helper: append message to chat
    function appendMessage(data, isPrivate) {
      const time = new Date(data.date_sent).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const isBot = data.from_user === 'Chat App Bot';
      const privateClass = isPrivate ? ' private' : '';
      const botClass = isBot ? ' bot' : '';

      const html = `
        <div class="message${botClass}${privateClass}">
          <div class="meta">
            <strong>${data.from_user}</strong> ${time}
            ${isPrivate ? '<span class="private-chat-badge">Private</span>' : ''}
          </div>
          <div>${escapeHtml(data.message)}</div>
        </div>
      `;
      $('#messages').append(html);
      $('#messages').scrollTop($('#messages')[0].scrollHeight);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
